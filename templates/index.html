<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>MRI Cyber Doctor (MRICD)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <style>
        body {
            background-color: #1a1a1a;
        }
    </style>
</head>

<body class="text-white">
    <div class="container mx-auto p-4">
        <h1 class="text-3xl font-bold mb-4 text-center">MRI Cyber Doctor (MRICD)</h1>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 max-w-5xl mx-auto">
            <div class="space-y-3">
                <div class="grid grid-cols-2 gap-2">
                    <div class="aspect-square" id="dropzone-flair">
                        <div
                            class="flex flex-col items-center justify-center w-full h-full border-2 border-dashed border-gray-700 rounded-lg cursor-pointer hover:bg-gray-800 transition-colors duration-300">
                            <input type="file" accept="image/*" class="hidden" id="input-flair">
                            <div class="flex flex-col items-center justify-center pt-4 pb-5">
                                <i data-lucide="upload" class="w-8 h-8 mb-2 text-gray-500"></i>
                                <p class="mb-1 text-sm text-gray-500">
                                    <span class="font-semibold">Click to upload</span> or drag and drop
                                </p>
                                <p class="text-xs text-gray-500">FLAIR image</p>
                            </div>
                        </div>
                    </div>
                    <div class="aspect-square" id="dropzone-t1">
                        <div
                            class="flex flex-col items-center justify-center w-full h-full border-2 border-dashed border-gray-700 rounded-lg cursor-pointer hover:bg-gray-800 transition-colors duration-300">
                            <input type="file" accept="image/*" class="hidden" id="input-t1">
                            <div class="flex flex-col items-center justify-center pt-4 pb-5">
                                <i data-lucide="upload" class="w-8 h-8 mb-2 text-gray-500"></i>
                                <p class="mb-1 text-sm text-gray-500">
                                    <span class="font-semibold">Click to upload</span> or drag and drop
                                </p>
                                <p class="text-xs text-gray-500">T1 image</p>
                            </div>
                        </div>
                    </div>
                    <div class="aspect-square" id="dropzone-t1ce">
                        <div
                            class="flex flex-col items-center justify-center w-full h-full border-2 border-dashed border-gray-700 rounded-lg cursor-pointer hover:bg-gray-800 transition-colors duration-300">
                            <input type="file" accept="image/*" class="hidden" id="input-t1ce">
                            <div class="flex flex-col items-center justify-center pt-4 pb-5">
                                <i data-lucide="upload" class="w-8 h-8 mb-2 text-gray-500"></i>
                                <p class="mb-1 text-sm text-gray-500">
                                    <span class="font-semibold">Click to upload</span> or drag and drop
                                </p>
                                <p class="text-xs text-gray-500">T1CE image</p>
                            </div>
                        </div>
                    </div>
                    <div class="aspect-square" id="dropzone-t2">
                        <div
                            class="flex flex-col items-center justify-center w-full h-full border-2 border-dashed border-gray-700 rounded-lg cursor-pointer hover:bg-gray-800 transition-colors duration-300">
                            <input type="file" accept="image/*" class="hidden" id="input-t2">
                            <div class="flex flex-col items-center justify-center pt-4 pb-5">
                                <i data-lucide="upload" class="w-8 h-8 mb-2 text-gray-500"></i>
                                <p class="mb-1 text-sm text-gray-500">
                                    <span class="font-semibold">Click to upload</span> or drag and drop
                                </p>
                                <p class="text-xs text-gray-500">T2 image</p>
                            </div>
                        </div>
                    </div>
                </div>
                <button id="submit-button"
                    class="w-full bg-gray-800 text-white py-2 rounded-lg hover:bg-gray-700 transition-colors duration-300 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed"
                    disabled>
                    <i data-lucide="check" class="w-5 h-5 mr-2"></i> Submit Images
                </button>
            </div>
            <div class="space-y-3">
                <div id="display-area" class="relative aspect-square bg-gray-700 rounded-lg flex items-center justify-center">
                    <i data-lucide="image" class="w-12 h-12 text-gray-400"></i>
                </div>
                <div class="flex flex-wrap gap-3">
                    <div class="flex items-center">
                        <input type="checkbox" id="checkbox-flair"
                            class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500">
                        <label for="checkbox-flair" class="ml-2 text-sm font-medium text-gray-300">Show FLAIR</label>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="checkbox-t1"
                            class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500">
                        <label for="checkbox-t1" class="ml-2 text-sm font-medium text-gray-300">Show T1</label>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="checkbox-t1ce"
                            class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500">
                        <label for="checkbox-t1ce" class="ml-2 text-sm font-medium text-gray-300">Show T1CE</label>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="checkbox-t2"
                            class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500">
                        <label for="checkbox-t2" class="ml-2 text-sm font-medium text-gray-300">Show T2</label>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="checkbox-seg" checked
                            class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500">
                        <label for="checkbox-seg" class="ml-2 text-sm font-medium text-gray-300">Show SEG</label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="modal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden">
        <div class="bg-gray-800 text-white p-6 rounded-lg max-w-sm w-full">
            <div id="modal-content" class="mb-4"></div>
            <button id="modal-close"
                class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg">Close</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();

            const images = {
                flair: null,
                t1: null,
                t1ce: null,
                t2: null,
                seg: null
            };
            const visibleLayers = {
                flair: false,
                t1: false,
                t1ce: false,
                t2: false,
                seg: true
            };

            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modal-content');
            const modalClose = document.getElementById('modal-close');

            function showModal(message) {
                modalContent.textContent = message;
                modal.classList.remove('hidden');
            }

            modalClose.addEventListener('click', () => {
                modal.classList.add('hidden');
            });

            function setImage(type, src) {
                images[type] = src;
                const dropzone = document.getElementById(`dropzone-${type}`);
                dropzone.innerHTML = `
                    <div class="relative w-full h-full">
                        <img src="${src}" alt="${type}" class="object-cover w-full h-full rounded-lg">
                        <i data-lucide="check" class="absolute top-2 right-2 text-green-500 w-6 h-6"></i>
                    </div>
                `;
                lucide.createIcons();
                checkAllImages();
                updateDisplay();
            }

            function handleFiles(event, type) {
                const file = event.target.files[0];
                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        setImage(type, e.target.result);
                    };
                    reader.readAsDataURL(file);
                }
            }

            function setupDropzone(type) {
                const dropzone = document.getElementById(`dropzone-${type}`);
                const input = document.getElementById(`input-${type}`);

                dropzone.addEventListener('click', () => input.click());
                input.addEventListener('change', (e) => handleFiles(e, type));

                dropzone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropzone.classList.add('bg-gray-800');
                });

                dropzone.addEventListener('dragleave', () => {
                    dropzone.classList.remove('bg-gray-800');
                });

                dropzone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropzone.classList.remove('bg-gray-800');
                    const file = e.dataTransfer.files[0];
                    if (file && file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = function (ev) {
                            setImage(type, ev.target.result);
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }

            function checkAllImages() {
                const allSelected = Object.values(images).slice(0, 4).every(img => img !== null);
                const submitButton = document.getElementById('submit-button');
                if (allSelected) {
                    submitButton.disabled = false;
                } else {
                    submitButton.disabled = true;
                }
            }

            ['flair', 't1', 't1ce', 't2'].forEach(setupDropzone);

            document.getElementById('submit-button').addEventListener('click', async () => {
                const submitButton = document.getElementById('submit-button');
                submitButton.disabled = true;
                submitButton.classList.add('opacity-50', 'cursor-not-allowed');
                submitButton.innerHTML = `<i data-lucide="loader" class="w-5 h-5 animate-spin mr-2"></i> Submitting...`;
                lucide.createIcons();

                try {
                    const formData = new FormData();
                    for (const type of ['flair', 't1', 't1ce', 't2']) {
                        const src = images[type];
                        const blob = await fetch(src).then(r => r.blob());
                        formData.append(type, blob, `${type}.jpg`);
                    }

                    const response = await fetch('/upload', {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Server error');
                    }

                    const blob = await response.blob();
                    const url = URL.createObjectURL(blob);
                    images.seg = url;
                    visibleLayers.seg = true;
                    document.getElementById('checkbox-seg').checked = true;
                    updateDisplay();
                } catch (error) {
                    showModal(error.message);
                } finally {
                    submitButton.disabled = false;
                    submitButton.classList.remove('opacity-50', 'cursor-not-allowed');
                    submitButton.innerHTML = `<i data-lucide="check" class="w-5 h-5 mr-2"></i> Submit Images`;
                    lucide.createIcons();
                }
            });

            function updateDisplay() {
                const displayArea = document.getElementById('display-area');
                displayArea.innerHTML = '';

                const selectedLayers = Object.keys(visibleLayers).filter(layer => visibleLayers[layer] && images[layer]);

                if (selectedLayers.length === 0) {
                    displayArea.innerHTML = `<i data-lucide="image" class="w-12 h-12 text-gray-400"></i>`;
                    lucide.createIcons();
                    return;
                }

                let opacityMap = {};
                if (selectedLayers.includes('seg')) {
                    opacityMap['seg'] = 0.5;
                    const remainingOpacity = 0.5;
                    const otherLayers = selectedLayers.filter(layer => layer !== 'seg');
                    const count = otherLayers.length;
                    if (count > 0) {
                        const otherOpacity = remainingOpacity / count;
                        otherLayers.forEach(layer => {
                            opacityMap[layer] = otherOpacity;
                        });
                    }
                } else {
                    const opacity = 1 / selectedLayers.length;
                    selectedLayers.forEach(layer => {
                        opacityMap[layer] = opacity;
                    });
                }

                selectedLayers.forEach(layer => {
                    const img = document.createElement('img');
                    img.src = images[layer];
                    img.alt = layer;
                    img.classList.add('object-cover', 'w-full', 'h-full', 'rounded-lg', 'absolute', 'top-0', 'left-0');
                    img.style.opacity = opacityMap[layer];
                    displayArea.appendChild(img);
                });

                lucide.createIcons();
            }

            ['flair', 't1', 't1ce', 't2', 'seg'].forEach(layer => {
                const checkbox = document.getElementById(`checkbox-${layer}`);
                checkbox.addEventListener('change', () => {
                    visibleLayers[layer] = checkbox.checked;
                    if (layer === 'seg' && !checkbox.checked) {
                        images.seg = null;
                    }
                    updateDisplay();
                });
            });
        });
    </script>
</body>

</html>